default: check

# Type-check the workspace
check:
    cargo check --workspace --all-targets

# Format all code
fmt:
    cargo fmt --all

# Check formatting without modifying files
fmt-check:
    cargo fmt --all -- --check

# Run clippy lints
lint:
    cargo clippy --workspace --all-targets -- -D warnings

# Run all tests
test:
    cargo test --workspace

# Build debug binaries
build:
    cargo build --workspace

# Build release binaries
release:
    cargo build --workspace --release

# Check that omtsf-core compiles to WASM (compression excluded: zstd uses C bindings)
wasm-check:
    cargo build -p omtsf-core --target wasm32-unknown-unknown --no-default-features

# Run cargo-deny checks
deny:
    cargo deny check licenses bans sources

# Build documentation
doc:
    cargo doc --workspace --no-deps

# Full CI pipeline
ci: fmt-check lint test doc wasm-check deny

# Fast pre-commit checks
pre-commit: fmt-check lint test

# Run all criterion benchmarks
bench:
    cargo bench -p omtsf-bench

# Run a specific benchmark group
bench-group group:
    cargo bench -p omtsf-bench --bench {{group}}

# Run benchmarks in quick mode (fewer samples)
bench-quick:
    cargo bench -p omtsf-bench --bench parse_serialize -- --quick
    cargo bench -p omtsf-bench --bench graph_construction -- --quick
    cargo bench -p omtsf-bench --bench graph_queries -- --quick
    cargo bench -p omtsf-bench --bench subgraph_extraction -- --quick
    cargo bench -p omtsf-bench --bench cycle_detection -- --quick
    cargo bench -p omtsf-bench --bench validation -- --quick
    cargo bench -p omtsf-bench --bench merge_pipeline -- --quick
    cargo bench -p omtsf-bench --bench redaction -- --quick
    cargo bench -p omtsf-bench --bench diff -- --quick

# Generate the huge-tier fixture to disk (~500 MB)
gen-huge:
    cargo run --release -p omtsf-bench --bin gen-huge

# Run huge-tier benchmarks (~500 MB, 20-tier supply chain)
bench-huge:
    cargo bench -p omtsf-bench --bench huge_file
    cargo bench -p omtsf-bench --bench huge_cbor

# Run huge-tier CBOR benchmarks only
bench-huge-cbor:
    cargo bench -p omtsf-bench --bench huge_cbor

# Generate fixture files to disk for manual inspection
generate-fixtures:
    cargo test -p omtsf-bench -- generate_fixtures --ignored --nocapture
